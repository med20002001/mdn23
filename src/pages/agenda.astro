---
import Layout from "../layouts/Layout.astro";
import AgendaContainer from "../components/agenda/AgendaContainer";
import { getCollection } from 'astro:content';
import type { CollectionEntry } from 'astro:content';

type Event = CollectionEntry<'events'> & {
  slug: string;
  href: string;
};

const allEvents = await getCollection('events');

const events: Event[] = allEvents.map((event: CollectionEntry<'events'>): Event => ({
  ...event,
  slug: event.slug,
  href: `/agenda/${event.slug}`,
}));

const now = new Date();

const upcomingEvents: Event[] = events
  .filter((event: Event): boolean => event.data.date >= now)
  .sort((a: Event, b: Event): number => a.data.date.getTime() - b.data.date.getTime());

const pastEvents: Event[] = events
  .filter((event: Event): boolean => event.data.date < now)
  .sort((a: Event, b: Event): number => b.data.date.getTime() - a.data.date.getTime());

// Données pour la vue liste
const upcomingEventsData = upcomingEvents.map((e: Event) => ({
  month: e.data.month,
  day: e.data.day,
  year: e.data.year,
  datetime: e.data.datetime,
  title: e.data.title,
  location: e.data.location,
  description: e.data.description,
  image: e.data.image,
  href: e.href,
  date: e.data.date,
}));

const pastEventsData = pastEvents.map((e: Event) => ({
  month: e.data.month,
  day: e.data.day,
  year: e.data.year,
  datetime: e.data.datetime,
  title: e.data.title,
  location: e.data.location,
  description: e.data.description,
  image: e.data.image,
  href: e.href,
  date: e.data.date,
}));

// Données pour les calendriers
const calendarEvents = upcomingEvents.map((e: Event) => ({
  date: e.data.date,
  title: e.data.title,
  datetime: e.data.datetime,
  location: e.data.location,
  description: e.data.description,
  href: e.href,
}));
---

<Layout title="Agenda - Tous les événements">
  <main class="bg-white min-h-screen">
    
    <!-- Container React qui gère tout -->
    <AgendaContainer 
      client:load
      upcomingEvents={upcomingEventsData}
      pastEvents={pastEventsData}
      calendarEvents={calendarEvents}
    />

  </main>
</Layout>
