---
import Layout from "../layouts/Layout.astro";
import AgendaContainer from "../components/agenda/AgendaContainer";
import { getCollection, type CollectionEntry } from "astro:content";

type EventEntry = CollectionEntry<"events">;
type UIEvent = EventEntry & { href: string };

const events: UIEvent[] = (await getCollection("events")).map(
  (e: EventEntry): UIEvent => ({
    ...e,
    href: `/agenda/${e.slug}`,
  })
);

const now = new Date();

const isUpcoming = (e: UIEvent) => e.data.date >= now;
const isPast = (e: UIEvent) => e.data.date < now;

const sortAsc = (a: UIEvent, b: UIEvent) =>
  a.data.date.getTime() - b.data.date.getTime();

const sortDesc = (a: UIEvent, b: UIEvent) =>
  b.data.date.getTime() - a.data.date.getTime();

const mapToListItem = (e: UIEvent, id: string) => ({
  id,
  datetime: e.data.datetime,
  title: e.data.title,
  location: e.data.location,
  description: e.data.description,
  image: e.data.image,
  href: e.href,
  date: e.data.date,
  slug: e.slug,
});

const upcomingEventsData = events
  .filter(isUpcoming)
  .sort(sortAsc)
  .map((e, i) => mapToListItem(e, `upcoming-${i + 1}`));

const pastEventsData = events
  .filter(isPast)
  .sort(sortDesc)
  .map((e, i) => mapToListItem(e, `past-${i + 1}`));
---

<Layout title="Agenda - Tous les événements">
  <section class=" py-14 sm:py-20 min-h-screen">
    <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="bg-white rounded-2xl shadow-md p-6 sm:p-10 lg:p-14">

        <header class="mb-16 max-w-3xl">
          <h1 class="mt-2 text-3xl sm:text-4xl lg:text-5xl font-extrabold text-gray-900">
            Agenda
          </h1>

          <div
            class="h-1 w-20 rounded-full mb-6
                   bg-gradient-to-r from-red-500/40 to-green-500/40"
          ></div>
        </header>

        <AgendaContainer
          client:load
          upcomingEvents={upcomingEventsData}
          pastEvents={pastEventsData}
        />

      </div>
    </div>
  </section>
</Layout>
