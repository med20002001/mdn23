---
import Layout from "../layouts/Layout.astro";
import AgendaContainer from "../components/agenda/AgendaContainer";
import { getCollection, type CollectionEntry } from "astro:content";

type EventEntry = CollectionEntry<'events'>;
type UIEvent = EventEntry & { href: string };

const events: UIEvent[] = (await getCollection('events')).map(
  (e: EventEntry): UIEvent => ({
    ...e,
    href: `/agenda/${e.slug}`,
  })
);
const now = new Date();

const isUpcoming = (e: UIEvent) => e.data.date >= now;
const isPast = (e: UIEvent) => e.data.date < now;

const sortAsc = (a: UIEvent, b: UIEvent) =>
  a.data.date.getTime() - b.data.date.getTime();

const sortDesc = (a: UIEvent, b: UIEvent) =>
  b.data.date.getTime() - a.data.date.getTime();

const mapToListItem = (e: UIEvent, id: string) => ({
  id,
  datetime: e.data.datetime,
  title: e.data.title,
  location: e.data.location,
  description: e.data.description,
  image: e.data.image,
  href: e.href,
  date: e.data.date,
  slug: e.slug,
});

const upcomingEventsData = events
  .filter(isUpcoming)
  .sort(sortAsc)
  .map((e, i) => mapToListItem(e, `upcoming-${i + 1}`));

const pastEventsData = events
  .filter(isPast)
  .sort(sortDesc)
  .map((e, i) => mapToListItem(e, `past-${i + 1}`));
---

<Layout title="Agenda - Tous les événements">
  <main class="bg-white min-h-screen">
    <AgendaContainer 
      client:load
      upcomingEvents={upcomingEventsData}
      pastEvents={pastEventsData}    
    />
  </main>
</Layout>
