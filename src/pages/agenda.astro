---
import Layout from "../layouts/Layout.astro";
import { AgendaHeader, EventList } from "../components/agenda";
import { getCollection } from 'astro:content';
import type { CollectionEntry } from 'astro:content';

// ⭐ Définir le type Event étendu
type Event = CollectionEntry<'events'> & {
  slug: string;
  href: string;
};

// Récupérer tous les événements
const allEvents = await getCollection('events');

// ⭐ Typer le paramètre event dans map
const events: Event[] = allEvents.map((event: CollectionEntry<'events'>) => ({
  ...event,
  slug: event.slug,
  href: `/agenda/${event.slug}`,
}));

const now = new Date();

// ⭐ Typer les événements filtrés
const upcomingEvents = events
  .filter((event: Event) => event.data.date >= now)
  .sort((a: Event, b: Event) => a.data.date.getTime() - b.data.date.getTime());

const pastEvents = events
  .filter((event: Event) => event.data.date < now)
  .sort((a: Event, b: Event) => b.data.date.getTime() - a.data.date.getTime());

// ⭐ Préparer les données pour EventList avec typage
const upcomingEventsData = upcomingEvents.map((e: Event) => ({
  month: e.data.month,
  day: e.data.day,
  year: e.data.year,
  datetime: e.data.datetime,
  title: e.data.title,
  location: e.data.location,
  description: e.data.description,
  image: e.data.image,
  href: e.href,
  date: e.data.date,
}));

const pastEventsData = pastEvents.map((e: Event) => ({
  month: e.data.month,
  day: e.data.day,
  year: e.data.year,
  datetime: e.data.datetime,
  title: e.data.title,
  location: e.data.location,
  description: e.data.description,
  image: e.data.image,
  href: e.href,
  date: e.data.date,
}));
---

<Layout title="Agenda">
  <main class="bg-white min-h-screen">
    
    <!-- Header avec recherche, onglets et navigation -->
    <AgendaHeader client:load activeTab="liste" />

    <div class="max-w-6xl mx-auto px-4 py-10">
      
      <!-- Liste des événements à venir -->
      <EventList 
        client:load
        events={upcomingEventsData}
        title="Événements à venir"
        emptyMessage="Il n'y a pas d'évènements à venir."
      />

      <!-- Liste des événements passés -->
      {pastEventsData.length > 0 && (
        <div class="mt-16">
          <EventList 
            client:load
            events={pastEventsData}
            title="Derniers Événements passés"
            showPastIndicator={true}
          />
        </div>
      )}
    </div>
  </main>
</Layout>